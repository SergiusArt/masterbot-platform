# MasterBot Platform

–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Telegram-–±–æ—Ç–∞–º–∏ —Å –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:

```
masterbot-platform/
‚îú‚îÄ‚îÄ master_bot/              # Telegram –±–æ—Ç (aiogram 3.x)
‚îÇ   ‚îú‚îÄ‚îÄ handlers/            # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ impulse/         # –†–∞–∑–¥–µ–ª "–ò–º–ø—É–ª—å—Å—ã"
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bablo/           # –†–∞–∑–¥–µ–ª "Bablo"
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reports/         # –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin/           # –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings/        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏
‚îÇ   ‚îú‚îÄ‚îÄ keyboards/           # –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reply/           # Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ inline/          # Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ states/              # FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
‚îÇ   ‚îî‚îÄ‚îÄ services/            # HTTP-–∫–ª–∏–µ–Ω—Ç—ã, –æ—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π, –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
‚îú‚îÄ‚îÄ impulse_service/         # –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –∏–º–ø—É–ª—å—Å–æ–≤ (FastAPI)
‚îÇ   ‚îú‚îÄ‚îÄ api/                 # REST API endpoints
‚îÇ   ‚îú‚îÄ‚îÄ services/            # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ models/              # SQLAlchemy –º–æ–¥–µ–ª–∏
‚îÇ   ‚îî‚îÄ‚îÄ listeners/           # Telegram listener (Telethon)
‚îú‚îÄ‚îÄ bablo_service/           # –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ (FastAPI)
‚îÇ   ‚îú‚îÄ‚îÄ api/                 # REST API endpoints
‚îÇ   ‚îú‚îÄ‚îÄ services/            # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ models/              # SQLAlchemy –º–æ–¥–µ–ª–∏
‚îÇ   ‚îî‚îÄ‚îÄ listeners/           # Telegram listener (Telethon)
‚îú‚îÄ‚îÄ shared/                  # –û–±—â–∏–µ –º–æ–¥—É–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ database/            # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –∏ –º–∏–≥—Ä–∞—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ connection.py    # Async SQLAlchemy connection
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ migrations/      # SQL –º–∏–≥—Ä–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ utils/               # –£—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logger.py        # Logging utils
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ redis_client.py  # Redis wrapper
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ timezone.py      # Timezone utilities (parse, validate, convert)
‚îÇ   ‚îî‚îÄ‚îÄ constants.py         # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã (–Ω–∞–∑–≤–∞–Ω–∏—è –∫–Ω–æ–ø–æ–∫, –∫–æ–º–∞–Ω–¥)
‚îú‚îÄ‚îÄ scripts/                 # –£—Ç–∏–ª–∏—Ç—ã –∏ —Å–∫—Ä–∏–ø—Ç—ã
‚îî‚îÄ‚îÄ docker-compose.yml       # –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
```

### –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã

#### 1. Master Bot (port -)
–û—Å–Ω–æ–≤–Ω–æ–π Telegram –±–æ—Ç –Ω–∞ aiogram 3.x:
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∫–æ–º–∞–Ω–¥ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
- FSM-—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ –º–µ–Ω—é
- HTTP-–∫–ª–∏–µ–Ω—Ç—ã –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º–∏
- Redis pub/sub –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

#### 2. Impulse Service (port 8001)
–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –∞–Ω–∞–ª–∏–∑–∞ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã—Ö –∏–º–ø—É–ª—å—Å–æ–≤:
- REST API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- Telegram listener (Telethon) –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∫–∞–Ω–∞–ª–∞ —Å –∏–º–ø—É–ª—å—Å–∞–º–∏
- –ü–∞—Ä—Å–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–æ–≤ (—É—Ç—Ä–µ–Ω–Ω–∏–π 8:00, –≤–µ—á–µ—Ä–Ω–∏–π 20:00, –Ω–µ–¥–µ–ª—å–Ω—ã–π, –º–µ—Å—è—á–Ω—ã–π)
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∏–º–ø—É–ª—å—Å–∞—Ö —Ä–æ—Å—Ç–∞/–ø–∞–¥–µ–Ω–∏—è
- –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä—ã–Ω–∫–∞

#### 3. Bablo Service (port 8002)
–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤:
- REST API –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤
- Telegram listener –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∫–∞–Ω–∞–ª–∞ —Å —Å–∏–≥–Ω–∞–ª–∞–º–∏
- –ü–∞—Ä—Å–∏–Ω–≥ —Å–∏–≥–Ω–∞–ª–æ–≤ (direction, strength, timeframe, quality)
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—á–µ—Å—Ç–≤—É, —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞–º, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é
- –û—Ç—á—ë—Ç—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Å–∏–≥–Ω–∞–ª–∞–º
- –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

#### 4. PostgreSQL (port 5432)
–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è:
- –ò–º–ø—É–ª—å—Å–æ–≤ –∏ —Å–∏–≥–Ω–∞–ª–æ–≤
- –ù–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ò—Å—Ç–æ—Ä–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π

#### 5. Redis (port 6379)
- Pub/Sub –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏–∑ —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ –±–æ—Ç
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Docker & Docker Compose
- Python 3.11+ (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```bash
git clone https://github.com/SergiusArt/masterbot-platform.git
cd masterbot-platform
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
cp .env.example .env
```

–ó–∞–ø–æ–ª–Ω–∏—Ç–µ `.env` —Å–≤–æ–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏:

```env
# Telegram Bot
BOT_TOKEN=your_bot_token_here
ADMIN_ID=your_telegram_id_here

# Database
DB_USER=masterbot
DB_PASSWORD=your_secure_password
DB_NAME=masterbot_db

# Impulse Service - Telegram Listener
SOURCE_CHANNEL_ID=your_channel_id_here
TELEGRAM_API_ID=your_api_id_here
TELEGRAM_API_HASH=your_api_hash_here
TELEGRAM_SESSION_STRING=your_session_string_here
```

### 3. –ó–∞–ø—É—Å–∫

```bash
docker compose up -d
```

### 4. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

–ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É —Å PostgreSQL
docker compose exec postgres psql -U masterbot -d masterbot

# –í—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É
\i /migrations/001_initial_schema.sql
\i /migrations/002_add_bablo_tables.sql
\i /migrations/003_add_notifications_enabled.sql
\i /migrations/004_add_bablo_activity_fields.sql
\i /migrations/005_add_user_timezone.sql
\i /migrations/006_add_bablo_timeframe_columns.sql
\i /migrations/007_add_performance_indexes.sql
```

–ò–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π:

```bash
for migration in shared/database/migrations/*.sql; do
  docker compose exec -T postgres psql -U masterbot -d masterbot < "$migration"
done
```

### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

```bash
docker compose ps
docker compose logs -f
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å

#### –°–µ—Ä–≤–µ—Ä–Ω—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å

–í—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –Ω–∞ —Ä–∞–±–æ—Ç—É –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ `Europe/Moscow` (UTC+3):
- –£—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—á—ë—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ **8:00 –ø–æ –ú–æ—Å–∫–≤–µ**
- –í–µ—á–µ—Ä–Ω–∏–µ –æ—Ç—á—ë—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ **20:00 –ø–æ –ú–æ—Å–∫–≤–µ**
- –ù–µ–¥–µ–ª—å–Ω—ã–µ –æ—Ç—á—ë—Ç—ã ‚Äî –∫–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 8:00
- –ú–µ—Å—è—á–Ω—ã–µ –æ—Ç—á—ë—Ç—ã ‚Äî 1-–≥–æ —á–∏—Å–ª–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞ –≤ 8:00

–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è `TZ=${TIMEZONE}` –∏ `TIMEZONE=Europe/Moscow` –≤ docker-compose.yml.

#### –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–≤–æ–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –≤ –º–µ–Ω—é **‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí üåç –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å**:

1. **–í—ã–±–æ—Ä –∏–∑ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤**:
   - –ú–æ—Å–∫–≤–∞ (UTC+3)
   - –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥ (UTC+2)
   - –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥ (UTC+5)
   - –ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫ (UTC+7)
   - –í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫ (UTC+10)
   - –õ–æ–Ω–¥–æ–Ω (UTC+0)
   - –ù—å—é-–ô–æ—Ä–∫ (UTC-5)
   - –ò –¥—Ä—É–≥–∏–µ

2. **–†—É—á–Ω–æ–π –≤–≤–æ–¥ UTC offset**:
   - –§–æ—Ä–º–∞—Ç: —á–∏—Å–ª–æ –æ—Ç -12 –¥–æ +14
   - –ü—Ä–∏–º–µ—Ä—ã: `+3`, `-5`, `0`, `+5`

–í—Ä–µ–º—è –≤ —Å–∏–≥–Ω–∞–ª–∞—Ö Bablo –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ `.env`:

```env
# Telegram Bot
BOT_TOKEN=              # –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –æ—Ç @BotFather
ADMIN_ID=               # Telegram ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

# Database
DB_USER=masterbot
DB_PASSWORD=            # –ü–∞—Ä–æ–ª—å –ë–î
DB_NAME=masterbot
DB_HOST=postgres
DB_PORT=5432

# Redis
REDIS_HOST=redis
REDIS_PORT=6379

# Impulse Service
IMPULSE_SERVICE_URL=http://impulse_service:8001
SOURCE_CHANNEL_ID=      # ID –∫–∞–Ω–∞–ª–∞ —Å –∏–º–ø—É–ª—å—Å–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: -1002313787119)
TELEGRAM_API_ID=        # API ID –∏–∑ my.telegram.org
TELEGRAM_API_HASH=      # API Hash –∏–∑ my.telegram.org
TELEGRAM_SESSION_STRING= # Session string (–ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç)

# Bablo Service
BABLO_SERVICE_URL=http://bablo_service:8002
BABLO_CHANNEL_ID=       # ID –∫–∞–Ω–∞–ª–∞ —Å —Å–∏–≥–Ω–∞–ª–∞–º–∏ Bablo
```

## –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ (—Ç–µ—Å—Ç–æ–≤—ã–π –±–æ—Ç)

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `.env` —Å —Ç–æ–∫–µ–Ω–æ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –±–æ—Ç–∞ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.

### –ü—Ä–æ–¥–∞–∫—à–Ω –æ–∫—Ä—É–∂–µ–Ω–∏–µ

–°–æ–∑–¥–∞–π—Ç–µ `.env.production` —Å –ø—Ä–æ–¥–∞–∫—à–Ω-—Ç–æ–∫–µ–Ω–∞–º–∏ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:

```bash
docker compose --env-file .env.production up -d
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏

–ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç FSM (Finite State Machine) –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π:

```
–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
‚îú‚îÄ‚îÄ üìä –ò–º–ø—É–ª—å—Å—ã
‚îÇ   ‚îú‚îÄ‚îÄ üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (–∑–∞ –¥–µ–Ω—å/–Ω–µ–¥–µ–ª—é/–º–µ—Å—è—Ü)
‚îÇ   ‚îú‚îÄ‚îÄ üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ø–æ—Ä–æ–≥–∏ —Ä–æ—Å—Ç–∞/–ø–∞–¥–µ–Ω–∏—è)
‚îÇ   ‚îî‚îÄ‚îÄ ‚ö° –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
‚îú‚îÄ‚îÄ üí∞ Bablo
‚îÇ   ‚îú‚îÄ‚îÄ üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ üìã –°–∏–≥–Ω–∞–ª—ã (—Ñ–∏–ª—å—Ç—Ä –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –∏ —Ç–∞–π–º—Ñ—Ä–µ–π–º—É)
‚îÇ   ‚îú‚îÄ‚îÄ ‚ö° –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Å–∏–≥–Ω–∞–ª–æ–≤)
‚îÇ   ‚îî‚îÄ‚îÄ ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–∫–∞—á–µ—Å—Ç–≤–æ, —Ç–∞–π–º—Ñ—Ä–µ–π–º—ã, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
‚îú‚îÄ‚îÄ üìã –û—Ç—á—ë—Ç—ã (—É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–µ–Ω—é)
‚îÇ   ‚îú‚îÄ‚îÄ –í—ã–±–æ—Ä —Å–µ—Ä–≤–∏—Å–æ–≤: –ò–º–ø—É–ª—å—Å—ã, Bablo
‚îÇ   ‚îú‚îÄ‚îÄ –£—Ç—Ä–µ–Ω–Ω–∏–π –æ—Ç—á—ë—Ç (8:00)
‚îÇ   ‚îú‚îÄ‚îÄ –í–µ—á–µ—Ä–Ω–∏–π –æ—Ç—á—ë—Ç (20:00)
‚îÇ   ‚îú‚îÄ‚îÄ –ù–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç (–ø–Ω 8:00)
‚îÇ   ‚îî‚îÄ‚îÄ –ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç (1-–≥–æ —á–∏—Å–ª–∞ 8:00)
‚îú‚îÄ‚îÄ ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ üåç –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å (–≤—ã–±–æ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–æ–¥ UTC offset)
‚îî‚îÄ‚îÄ üîß –ê–¥–º–∏–Ω (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
```

## –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### –ò–º–ø—É–ª—å—Å—ã

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä —Å–∏–≥–Ω–∞–ª–æ–≤ –∏–∑ Telegram-–∫–∞–Ω–∞–ª–∞
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º (–¥–µ–Ω—å, –≤—á–µ—Ä–∞, –Ω–µ–¥–µ–ª—è, –º–µ—Å—è—Ü) —Å–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ–º —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –ø–µ—Ä–∏–æ–¥–æ–º
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ø–æ—Ä–æ–≥–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (—Ä–æ—Å—Ç/–ø–∞–¥–µ–Ω–∏–µ –≤ %)
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –ø–æ—Ä–æ–≥ –∑–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç—á–µ—Ç—ã (—É—Ç—Ä–µ–Ω–Ω–∏–π 8:00, –≤–µ—á–µ—Ä–Ω–∏–π 20:00, –Ω–µ–¥–µ–ª—å–Ω—ã–π, –º–µ—Å—è—á–Ω—ã–π)

### Bablo (—Ç–æ—Ä–≥–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã)

- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞–Ω–∞–ª–∞ —Å —Ç–æ—Ä–≥–æ–≤—ã–º–∏ —Å–∏–≥–Ω–∞–ª–∞–º–∏
- –ü–∞—Ä—Å–∏–Ω–≥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (long/short), —Å–∏–ª–∞ (1-5), —Ç–∞–π–º—Ñ—Ä–µ–π–º, –∫–∞—á–µ—Å—Ç–≤–æ
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º—É –∫–∞—á–µ—Å—Ç–≤—É —Å–∏–≥–Ω–∞–ª–∞ (1-10)
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞–º (1–º, 5–º, 15–º, 30–º, 1—á)
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º (long/short)
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –æ—Ç—á—ë—Ç—ã

### –û—Ç—á—ë—Ç—ã

- –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–µ–Ω—é –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç—á—ë—Ç–æ–≤
- –í—ã–±–æ—Ä —Å–µ—Ä–≤–∏—Å–æ–≤ (Impulse, Bablo) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç—á—ë—Ç–æ–≤
- –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç—ã –æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
- –¢–∏–ø—ã –æ—Ç—á—ë—Ç–æ–≤: —É—Ç—Ä–µ–Ω–Ω–∏–π, –≤–µ—á–µ—Ä–Ω–∏–π, –Ω–µ–¥–µ–ª—å–Ω—ã–π, –º–µ—Å—è—á–Ω—ã–π

### –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ

- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏

## API Endpoints

### Impulse Service (port 8001)

- `GET /health` ‚Äî –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞
- `GET /api/v1/impulses` ‚Äî –°–ø–∏—Å–æ–∫ –∏–º–ø—É–ª—å—Å–æ–≤ (—Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏)
- `GET /api/v1/analytics/{period}` ‚Äî –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥ (today, yesterday, week, month)
- `GET /api/v1/notifications/{user_id}` ‚Äî –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `PUT /api/v1/notifications/{user_id}` ‚Äî –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- `POST /api/v1/reports/{user_id}/{report_type}` ‚Äî –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞

### Bablo Service (port 8002)

- `GET /health` ‚Äî –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞
- `GET /api/v1/signals` ‚Äî –°–ø–∏—Å–æ–∫ —Å–∏–≥–Ω–∞–ª–æ–≤ (—Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏)
- `GET /api/v1/signals/latest` ‚Äî –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–∏–≥–Ω–∞–ª—ã
- `GET /api/v1/analytics/{period}` ‚Äî –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥
- `GET /api/v1/settings/{user_id}` ‚Äî –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `PUT /api/v1/settings/{user_id}` ‚Äî –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
- `POST /api/v1/reports/{user_id}` ‚Äî –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç pytest –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –¢–µ—Å—Ç—ã –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω—ã –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º –∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è —Å –∏–∑–æ–ª—è—Ü–∏–µ–π –º–æ–¥—É–ª–µ–π (–∫–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º pytest-–ø—Ä–æ—Ü–µ—Å—Å–µ).

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

```
tests/
‚îú‚îÄ‚îÄ unit/                           # –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã (~300 —Ç–µ—Å—Ç–æ–≤)
‚îÇ   ‚îú‚îÄ‚îÄ shared/                     # –¢–µ—Å—Ç—ã –æ–±—â–∏—Ö –º–æ–¥—É–ª–µ–π (~43)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_constants.py       # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã, enum-—ã, –∫–Ω–æ–ø–∫–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_timezone.py        # Timezone utilities (parse, validate, convert)
‚îÇ   ‚îú‚îÄ‚îÄ master_bot/                 # –¢–µ—Å—Ç—ã –±–æ—Ç–∞ (~100)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_navigation.py      # FSM –Ω–∞–≤–∏–≥–∞—Ü–∏—è, –º–µ–Ω—é, timezone keyboards
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_formatters.py      # format_analytics, format_impulse, comparison text
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_scheduler.py       # Report scheduler, –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_service_clients.py # HTTP-–∫–ª–∏–µ–Ω—Ç—ã –∫ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_message_queue.py   # Rate-limited –æ—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ impulse_service/            # –¢–µ—Å—Ç—ã –∏–º–ø—É–ª—å—Å–æ–≤ (67)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_parser.py          # –ü–∞—Ä—Å–µ—Ä –∏–º–ø—É–ª—å—Å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_scheduler.py       # –§–æ—Ä–º–∞—Ç –æ—Ç—á—ë—Ç–æ–≤, —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –º–æ–Ω–µ—Ç—ã, –ª–∏–¥–µ—Ä—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_signal_service.py  # Pydantic-—Å—Ö–µ–º—ã, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –ø–µ—Ä–∏–æ–¥—ã
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_api.py             # FastAPI endpoints (skip –±–µ–∑ fastapi)
‚îÇ   ‚îî‚îÄ‚îÄ bablo_service/              # –¢–µ—Å—Ç—ã Bablo (~80)
‚îÇ       ‚îú‚îÄ‚îÄ test_parser.py          # –ü–∞—Ä—Å–µ—Ä —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
‚îÇ       ‚îú‚îÄ‚îÄ test_signal_service.py  # –°–µ—Ä–≤–∏—Å —Å–∏–≥–Ω–∞–ª–æ–≤, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
‚îÇ       ‚îú‚îÄ‚îÄ test_activity_notifications.py # –ê–ª–µ—Ä—Ç—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, Redis –∫–ª—é—á–∏, cooldown
‚îÇ       ‚îî‚îÄ‚îÄ test_api.py             # FastAPI endpoints (skip –±–µ–∑ fastapi)
‚îú‚îÄ‚îÄ integration/                    # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (~30)
‚îÇ   ‚îú‚îÄ‚îÄ test_redis.py               # Redis ops, publish_batch, MGET/MSET
‚îÇ   ‚îî‚îÄ‚îÄ test_database.py            # DB connections
‚îú‚îÄ‚îÄ e2e/                            # –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (11)
‚îÇ   ‚îî‚îÄ‚îÄ test_navigation.py         # FSM state transitions —á–µ—Ä–µ–∑ handlers
‚îî‚îÄ‚îÄ conftest.py                     # –û–±—â–∏–π conftest (–ø—É—Ç–∏ –∫ —Å–µ—Ä–≤–∏—Å–∞–º)
```

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
# –í—Å–µ —Ç–µ—Å—Ç—ã (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å–ø–æ—Å–æ–± ‚Äî –∏–∑–æ–ª—è—Ü–∏—è –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º)
./run_tests.sh all

# –¢–æ–ª—å–∫–æ —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã
./run_tests.sh unit

# –¢–æ–ª—å–∫–æ e2e —Ç–µ—Å—Ç—ã
./run_tests.sh e2e

# –¢–µ—Å—Ç—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
pytest tests/unit/master_bot/ -v
pytest tests/unit/impulse_service/ -v
pytest tests/unit/bablo_service/ -v

# –° –ø–æ–∫—Ä—ã—Ç–∏–µ–º –∫–æ–¥–∞
pytest --cov=master_bot --cov=impulse_service --cov=bablo_service tests/unit/shared/ tests/unit/master_bot/
```

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

- **–ò–∑–æ–ª—è—Ü–∏—è –º–æ–¥—É–ª–µ–π**: –°–µ—Ä–≤–∏—Å—ã –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∏–º–µ–Ω–∞ –ø–∞–∫–µ—Ç–æ–≤ (`services/`, `core/`, `models/`), –ø–æ—ç—Ç–æ–º—É —Ç–µ—Å—Ç—ã –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º pytest-–ø—Ä–æ—Ü–µ—Å—Å–µ —á–µ—Ä–µ–∑ `run_tests.sh`
- **conftest.py**: –í –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö `impulse_service/` –∏ `bablo_service/` –µ—Å—Ç—å conftest-—Ñ–∞–π–ª—ã, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—â–∏–µ `sys.path` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π
- **fastapi skip**: –¢–µ—Å—Ç—ã API –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è –µ—Å–ª–∏ fastapi –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (`pytest.importorskip`)

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **Python 3.11**
- **aiogram 3.x** ‚Äî Telegram Bot API
- **FastAPI** ‚Äî REST API
- **SQLAlchemy 2.0** ‚Äî Async ORM
- **PostgreSQL 15** ‚Äî –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- **Redis 7** ‚Äî –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ Pub/Sub
- **Telethon** ‚Äî Telegram MTProto API –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –∫–∞–Ω–∞–ª–æ–≤
- **Docker Compose** ‚Äî –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è
- **pytest** ‚Äî –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

## Troubleshooting

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∏–º–ø—É–ª—å—Å–∞—Ö –∏–ª–∏ —Å–∏–≥–Ω–∞–ª–∞—Ö.

**–ü—Ä–∏—á–∏–Ω—ã –∏ —Ä–µ—à–µ–Ω–∏—è**:

1. **Notification listener –Ω–µ –∑–∞–ø—É—â–µ–Ω**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `docker compose logs master_bot | grep notification`
   - –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞: `‚úÖ Subscribed to channels: impulse:notifications, bablo:notifications`
   - –ï—Å–ª–∏ –Ω–µ—Ç, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ: `docker compose restart master_bot`

2. **Telegram listener –æ—Ç–∫–ª—é—á–∏–ª—Å—è**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `docker compose logs impulse_service | grep listener`
   - –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞: `‚úÖ Listening to channel: -1002313787119`
   - –ï—Å–ª–∏ –Ω–µ—Ç, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ: `docker compose restart impulse_service`

3. **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤—ã–∫–ª—é—á–µ–Ω—ã**
   ```sql
   -- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   docker compose exec postgres psql -U masterbot -d masterbot_db -c \
     "SELECT user_id, notifications_enabled, growth_threshold, fall_threshold
      FROM user_notification_settings WHERE user_id = YOUR_USER_ID;"
   ```

4. **–ü–æ—Ä–æ–≥–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã**
   - –ò–º–ø—É–ª—å—Å—ã: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–æ—Å—Ç ‚â•20%, –ø–∞–¥–µ–Ω–∏–µ ‚â§-20%
   - Bablo: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é quality ‚â•7, strength ‚â•3

### –ù–∞–≤–∏–≥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–ü—Ä–æ–±–ª–µ–º–∞**: –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –º–µ–Ω—é.

**–†–µ—à–µ–Ω–∏–µ**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è –∫–æ–¥–∞ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏ FSM states:
```bash
git pull origin main
docker compose build --no-cache master_bot
docker compose restart master_bot
```

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**:
- Activity handlers —Ç–µ–ø–µ—Ä—å —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –ø–æ FSM state (MenuState.bablo_activity, MenuState.impulse_activity)
- Admin service status button –∏–∑–º–µ–Ω—ë–Ω —Å üìä –Ω–∞ üîç –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞

### Redis pub/sub –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis
docker compose exec redis redis-cli PING

# –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
docker compose exec redis redis-cli PUBLISH "bablo:notifications" \
  '{"event":"test","user_id":123,"data":{"test":"message"}}'

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ master_bot
docker compose logs master_bot --tail=20 | grep "Received notification"
```

### Telegram listener –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
docker compose logs impulse_service | grep "Telegram client connected"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–º–ø—É–ª—å—Å—ã –≤ –ë–î
docker compose exec postgres psql -U masterbot -d masterbot_db -c \
  "SELECT symbol, percent, type, received_at FROM impulses
   ORDER BY received_at DESC LIMIT 5;"
```

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã**:
- –ò—Å—Ç–µ–∫–ª–∞ —Å–µ—Å—Å–∏—è Telegram (TELEGRAM_SESSION_STRING)
- –ò–∑–º–µ–Ω–∏–ª—Å—è ID –∫–∞–Ω–∞–ª–∞ (SOURCE_CHANNEL_ID)
- –ö–∞–Ω–∞–ª –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω (–Ω–µ—Ç –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å listener
docker compose restart impulse_service bablo_service

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
docker compose exec impulse_service env | grep TELEGRAM
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –¥–ª—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏:

```bash
# –í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ impulse_service
docker compose exec impulse_service python scripts/test_telegram_connection.py

# –ò–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ
cd masterbot-platform
python scripts/test_telegram_connection.py
```

**–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç**:
1. ‚úÖ –ù–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö credentials –≤ .env
2. ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Telegram API
3. ‚úÖ –í–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Å–µ—Å—Å–∏–∏
4. ‚úÖ –î–æ—Å—Ç—É–ø –∫ —Ü–µ–ª–µ–≤–æ–º—É –∫–∞–Ω–∞–ª—É
5. ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

**–¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏**:

- `Connection timeout (30 seconds)` - –ø—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç—å—é –∏–ª–∏ firewall
- `Failed to access channel` - —Å–µ—Å—Å–∏—è revoked –∏–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–Ω–∞–ª—É
- `Invalid channel ID format` - –Ω–µ–≤–µ—Ä–Ω—ã–π SOURCE_CHANNEL_ID –≤ .env
- `Session has been revoked` - –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å TELEGRAM_SESSION_STRING

**–î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏**:
```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–ª–Ω—ã–µ –ª–æ–≥–∏ –∑–∞–ø—É—Å–∫–∞ listener
docker compose logs impulse_service | grep -A 20 "Starting Telegram listener"

# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ç–∞–∫–∏–µ —Å—Ç—Ä–æ–∫–∏:
# ‚úÖ TELEGRAM_API_ID present: True
# ‚úÖ TELEGRAM_SESSION_STRING present: True
# ‚úÖ Telegram client connected successfully!
# ‚úÖ Listening to channel: -1002313787119
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–æ–≤

```bash
# –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã
docker compose ps

# Health checks
curl http://localhost:8001/health  # Impulse Service
curl http://localhost:8002/health  # Bablo Service

# –õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
docker compose logs -f master_bot
docker compose logs -f impulse_service
docker compose logs -f bablo_service
```

### –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å—ë
docker compose down
docker compose build --no-cache
docker compose up -d

# –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã
docker system prune -a

# –ë—ç–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
docker compose exec postgres pg_dump -U masterbot masterbot_db > backup.sql

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
docker compose exec -T postgres psql -U masterbot -d masterbot_db < backup.sql
```

## –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ (500+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)

–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- Partial indexes –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (migration 007)
- –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ threshold, activity, report columns

### Redis –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- **MGET/MSET batching** ‚Äî –º–∞—Å—Å–æ–≤–æ–µ —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å –≤–º–µ—Å—Ç–æ N –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
- **Pipeline publish** ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ 1 —Å–µ—Ç–µ–≤–æ–π –≤—ã–∑–æ–≤

### Telegram Message Queue
Rate-limited –æ—á–µ—Ä–µ–¥—å (25 msg/sec) –¥–ª—è —Å–æ–±–ª—é–¥–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ API:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –ø—Ä–∏ rate limiting
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

–§–∞–π–ª: `master_bot/services/message_queue.py`

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á—ë—Ç–æ–≤
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞ –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –≤—Å–µ—Ö (market data –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è)
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –ø–æ–¥–ø–∏—Å–∫–∞–º
- Bulk send —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å

### Activity Alert Cooldown
60-—Å–µ–∫—É–Ω–¥–Ω—ã–π cooldown –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:
- –†–µ—à–∞–µ—Ç race condition –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–º –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤
- –ë–µ–∑ cooldown: 4 —Å–∏–≥–Ω–∞–ª–∞ –∑–∞ 1 —Å–µ–∫ = 4 —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–±–∞–≥)
- –° cooldown: 4 —Å–∏–≥–Ω–∞–ª–∞ –∑–∞ 1 —Å–µ–∫ = 1 —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

### –†–µ–∑—É–ª—å—Ç–∞—Ç
| –û–ø–µ—Ä–∞—Ü–∏—è | –ë—ã–ª–æ | –°—Ç–∞–ª–æ |
|----------|------|-------|
| Redis publish (500 users) | 500 calls, ~2.5s | 1 pipeline, ~5ms |
| Report generation | N API calls | 2 API calls |
| Telegram send | sequential | queued, 25 msg/sec |
| DB user queries | full scan | index scan |

## –õ–∏—Ü–µ–Ω–∑–∏—è

Private / All rights reserved
